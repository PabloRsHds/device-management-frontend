<div class="body">

  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Device Management</h3>
      <div class="separator"></div>
    </div>
    <div class="sidebar-menu">
      <button class="menu-button"
        *ngFor="let button of buttons"
        (click)="toggleButton(button.id)"
        [ngClass]="{'button-pressed':button.pressed}">
          {{button.title}}
      </button>
    </div>
  </div>

  <div class="main-content" *ngIf="!buttons[0].pressed && !buttons[1].pressed && !buttons[2].pressed">
    <div class="welcome-container">
      <h1 class="welcome-title">Welcome to Device Management</h1>
      <p class="welcome-subtitle">This is the place where you can manage your devices</p>
    </div>
  </div>

  <div class="main-content-form" *ngIf="buttons[0].pressed">
    <div class="form-container">
      <h1 class="form-title">Register Device</h1>

      <form method="post" [formGroup]="registerForm" (ngSubmit)="register()">
        <div class="form-group">
          <input type="text" formControlName="name" class="form-input" placeholder="Enter device name">

          <small *ngIf="registerForm.get('name')?.touched && registerForm.get('name')?.hasError('required')">
            Device name is mandatory.
          </small>
        </div>


        <div class="form-group">
          <select class="form-input" formControlName="type">
            <option value="">Select a type</option>
            <option *ngFor="let item of types" [value]="item">
              {{ item }}
            </option>
          </select>
          <small *ngIf="registerForm.get('type')?.touched && registerForm.get('type')?.hasError('required')">
            Type is mandatory.
          </small>
        </div>

        <div class="form-group">
          <input type="text" formControlName="deviceModel" class="form-input" placeholder="Enter device model">
          <small *ngIf="registerForm.get('deviceModel')?.touched && registerForm.get('deviceModel')?.hasError('required')">
            Device Model is mandatory.
          </small>
        </div>

        <div class="form-group">
          <input type="text" formControlName="manufacturer" class="form-input" placeholder="Enter manufacturer">
          <small *ngIf="registerForm.get('manufacturer')?.touched && registerForm.get('manufacturer')?.hasError('required')">
            Manufacturer is mandatory.
          </small>
        </div>

        <div class="form-group">
          <textarea rows="2" cols="50" formControlName="location" class="form-input" placeholder="Enter a location"></textarea>
          <small *ngIf="registerForm.get('location')?.touched && registerForm.get('location')?.hasError('required')">
            Location is mandatory.
          </small>
        </div>

        <div class="form-group">
          <textarea rows="3" cols="50" formControlName="description" class="form-input" placeholder="Enter description"></textarea>
          <small *ngIf="registerForm.get('description')?.touched && registerForm.get('description')?.hasError('required')">
            Description is mandatory.
          </small>
        </div>

        <div class="form-buttons">
          <button type="submit" class="form-button register-button" [disabled]="registerForm.invalid">Register</button>
          <button type="button" class="form-button cancel-button">Cancel</button>
        </div>

      </form>

    </div>
  </div>

  <div class="main-content-table" *ngIf="buttons[1].pressed">

    <div class="table-container">

      <div class="search-container">
        <h2>All Devices</h2>
        <div class="icon" *ngIf="countNotifications > 0 && countNotifications < 10">{{countNotifications}}</div>
        <div class="icon" *ngIf="countNotifications > 9">9+</div>
        <button (click)="openNotifications()">ðŸ””</button>
      </div>

      <div style="padding: 40px;">
        <div>
          <input [(ngModel)]="searchTerm" type="text" placeholder="Search devices" class="search-input">
        </div>
        <table class="device-table">
          <thead>
            <tr>
              <th>Device Name</th>
              <th>Type</th>
              <th>Model</th>
              <th>Description</th>
              <th>Manufacturer</th>
              <th>Min Limit</th>
              <th>Max Limit</th>
              <th>Unit</th>
              <th>Location</th>
              <th colspan="3">Actions</th>
            </tr>
          </thead>
          <tbody *ngFor="let device of paginatedDevices">
            <tr>
              <td>{{device.name}}</td>
              <td>{{device.type}}</td>
              <td>{{device.deviceModel}}</td>
              <td>
                <button (click)="functionTableInspection(device.description)" class="button-info">Description</button>
              </td>
              <td>{{device.manufacturer}}</td>
              <td>{{device.minLimit}}</td>
              <td>{{device.maxLimit}}</td>
              <td>{{device.unit}}</td>
              <td>
                <button (click)="functionTableInspection(device.location)" class="button-info">Location</button>
              </td>
              <td>
                <button class="action-button test-button" (click)="functionChangeStatus(device.deviceModel)">Test</button>
              </td>
              <td>
                <button class="action-button edit-button" (click)="functionButtonUpdate(device.deviceModel)">Edit</button>
              </td>
              <td>
                <button class="action-button delete-button" (click)="functionButtonDelete(device.deviceModel);">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="pagination">
          <button (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
          <span class="pagination-info">Page {{ currentPage }} of {{ totalPages }}</span>
          <button (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
        </div>

      </div>
    </div>
  </div>

  <div class="modal-notifications" *ngIf="openModalNotifications">
    <div class="modal-notifications-content"
    (scroll)="onScroll($event)">
      <div>
        <h2>Notifications</h2>
      </div>
      <div class="content" *ngFor="let notification of listNotifications">
        <div>
          <p (click)="ocultNotifications(notification.notificationId)">X</p>
        </div>
        <div>
          <span>{{notification.message}}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-description" *ngIf="openModalDescription">
    <div class="modal-description-content">
      <p class="close-button" (click)="openModalDescription = !openModalDescription">X</p>
      <p class="modal-description-text">{{selectedDeviceDescription}}</p>
    </div>
  </div>

  <div class="modal-location" *ngIf="openModalLocation">
    <div class="modal-location-content">
      <p class="close-button" (click)="openModalLocation = !openModalLocation">X</p>
      <p class="modal-location-text">{{selectedDeviceLocation}}</p>
    </div>
  </div>

  <!-- Device Update Modal -->
  <div class="update-modal" *ngIf="openModalDeviceUpdate">
    <div class="update-modal-content">
      <div>
        <div class="form-container" [ngClass]="{'form-container-update': openModalDeviceUpdate}">
          <p class="close-button-update" (click)="closeModalDeviceUpdate()">X</p>
          <h1 class="form-title">Update Device</h1>

          <form method="put" [formGroup]="updateForm" (ngSubmit)="update()">

            <button class="button-update" *ngIf="!updateDeviceName" (click)="updateDeviceName = !updateDeviceName">Update Device name</button>
            <div class="form-group" *ngIf="updateDeviceName">
              <div style="display: flex; align-items: center; flex-direction: row;">
                <input type="text" formControlName="newName" class="form-input" placeholder="Enter device name">
                <span (click)="updateDeviceName = !updateDeviceName">X</span>
              </div>
            </div>

            <button class="button-update" *ngIf="!updateDeviceModel" (click)="updateDeviceModel = !updateDeviceModel">Update Device model</button>
            <div class="form-group" *ngIf="updateDeviceModel">
              <div style="display: flex; align-items: center; flex-direction: row;">
                <input type="text" formControlName="newDeviceModel" class="form-input" placeholder="Enter device model">
                <span (click)="updateDeviceModel = !updateDeviceModel">X</span>
              </div>
            </div>

            <button class="button-update" *ngIf="!updateManufacturer" (click)="updateManufacturer = !updateManufacturer">Update Manufacturer</button>
            <div class="form-group" *ngIf="updateManufacturer">
              <div style="display: flex; align-items: center; flex-direction: row;">
                <input type="text" formControlName="newManufacturer" class="form-input" placeholder="Enter manufacturer">
                <span (click)="updateManufacturer = !updateManufacturer">X</span>
              </div>
            </div>

            <button class="button-update" *ngIf="!updateLocation" (click)="updateLocation = !updateLocation">Update Location</button>
            <div class="form-group" *ngIf="updateLocation">
              <div style="display: flex; align-items: center; flex-direction: row;">
                <textarea rows="2" cols="50" formControlName="newLocation" class="form-input" placeholder="Enter a location"></textarea>
                <span style="margin-bottom: 25px;" (click)="updateLocation = !updateLocation">X</span>
              </div>
            </div>

            <button class="button-update" *ngIf="!updateDescription" (click)="updateDescription = !updateDescription">Update description</button>
            <div class="form-group" *ngIf="updateDescription">
              <div style="display: flex; align-items: center; flex-direction: row;">
                <textarea rows="4" cols="50" formControlName="newDescription" class="form-input" placeholder="Enter a description"></textarea>
                <span style="margin-bottom: 58px;" (click)="updateDescription = !updateDescription">X</span>
              </div>
            </div>

            <div class="form-buttons">
              <button type="submit" class="form-button register-button">Update</button>
              <button type="button" class="form-button cancel-button" (click)="closeModalDeviceUpdate()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
  <!---->

  <!-- Device Delete Modal -->

  <div class="delete-modal" *ngIf="openModalDeviceDelete">
    <div class="delete-modal-content">
      <p class="close-button" (click)="openModalDeviceDelete = !openModalDeviceDelete">X</p>

      <div style="display: flex; align-items: center; flex-direction: column;">
        <h1 class="delete-modal-title">Delete Device</h1>
        <p class="delete-modal-text">Are you sure you want to delete this device?</p>

        <form method="delete" [formGroup]="deleteForm" (ngSubmit)="delete()">
          <div class="delete-modal-buttons">
            <input style="display: none;" type="text" formControlName="deviceModel">
            <button type="submit" class="delete-modal-button">Delete</button>
            <button type="button" class="delete-modal-button-cancel" (click)="openModalDeviceDelete = !openModalDeviceDelete">Cancel</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <!---->

  <!-- Device Analysis Modal -->
  <div class="analysis-modal" *ngIf="openModalTableInspection">
    <div class="modal-content">

      <div class="close-button">
        <span (click)="openModalTableInspection = !openModalTableInspection">X</span>
      </div>

      <div class="modal-title">
        <div>
          <h1>Device model: <span>{{deviceModel}}</span></h1>
          <p>Configuration, monitoring and history</p>
        </div>
        <div class="reload-button">
          <button (click)="reloadAnalysis()">Reload</button>
          <button style="margin-right: 70px;" (click)="functionChangeStatus(this.deviceModel)">Disable</button>
        </div>
      </div>

      <div class="modal-cards">

        <div class="card-1">
          <h2>Current Settings</h2>
          <div>
            <p>Min limit</p>
            <p class="value">{{deviceAnalysis.minLimit}} {{unit}}</p>

            <div class="separator-card"></div>

            <p>Max limit</p>
            <p class="value">{{deviceAnalysis.maxLimit}} {{unit}}</p>

            <div class="separator-card"></div>

            <p>Unit</p>
            <p class="value">{{deviceAnalysis.unit}}</p>

            <div class="separator-card"></div>

            <p>CreatedAt</p>
            <p class="value">{{deviceAnalysis.createdAt}}</p>

            <div class="separator-card"></div>

            <p>UpdateAt</p>
            <p class="value">{{deviceAnalysis.updatedAt}}</p>
          </div>
        </div>

        <div class="card-2">
          <h2>Previous configuration</h2>
          <div>
            <p>Min limit</p>
            <p class="value">{{deviceAnalysis.lastReadingMinLimit}} {{unit}}</p>

            <div class="separator-card"></div>

            <p>Max limit</p>
            <p class="value">{{deviceAnalysis.lastReadingMaxLimit}} {{unit}}</p>

            <div class="separator-card"></div>

            <p>Unit</p>
            <p class="value">{{deviceAnalysis.unit}}</p>

            <div class="separator-card"></div>

            <p>UpdateAt</p>
            <p class="value">{{deviceAnalysis.lastReadingUpdateAt}}</p>
          </div>
        </div>

        <div class="card-3">
          <h2>Operation Status</h2>
          <div>
            <div echarts [options]="chartOptions" class="chart"></div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!---->

  <div class="main-content-analysis" *ngIf="buttons[2].pressed">

    <div class="analysis-container">

      <div class="search-container">
        <h2>All Devices</h2>
        <div class="icon" *ngIf="countNotifications > 0 && countNotifications < 10">{{countNotifications}}</div>
        <div class="icon" *ngIf="countNotifications > 9">9+</div>
        <button (click)="openNotifications()">ðŸ””</button>
      </div>

      <div style="padding: 40px;">
        <div>
          <input type="text" placeholder="Search" class="search-input" [(ngModel)]="searchTermSensors">
        </div>
        <table class="devices-table" >
          <thead>
            <tr>
              <th>Device Name</th>
              <th>Type</th>
              <th>Model</th>
              <th>Manufacturer</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody *ngFor="let sensor of paginateSensorsActivated" (click)="deviceForAnalysis(sensor.deviceModel)">
            <tr>
              <td>{{sensor.name}}</td>
              <td>{{sensor.type}}</td>
              <td class="current-value">{{sensor.deviceModel}}</td>
              <td class="previous-value">{{sensor.manufacturer}}</td>
              <td><span class="status-indicator status-active"></span>{{sensor.status}}</td>
            </tr>
          </tbody>
        </table>
        <div class="pagination">
          <button (click)="previousPageSensorsActivated()" [disabled]="currentPageSensors === 1">Previous</button>
          <span class="pagination-info">Page {{ currentPageSensors }} of {{ totalPagesSensorsActivated }}</span>
          <button (click)="nextPageSensorsActivated()" [disabled]="currentPageSensors === totalPagesSensorsActivated">Next</button>
        </div>
      </div>
    </div>
  </div>

</div>
